<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ” Google Photos Token æ¸¬è©¦å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src 'self' https://accounts.google.com https://apis.google.com;
      connect-src *;
      style-src 'self' 'unsafe-inline';
    ">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    button { padding: 10px 20px; font-size: 1rem; }
    pre { background: #eee; padding: 1rem; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>ğŸ“· Google Photos Redirect æ¸¬è©¦</h2>
  <button id="authorize-btn">ç™»å…¥ Google ä¸¦äº¤æ› token</button>
  <pre id="output">ğŸ“ ç­‰å¾…ä½¿ç”¨è€…æ“ä½œ...</pre>

  <script>
    const CLIENT_ID = "1004388657829-mvpott95dsl5bapu40vi2n5li7i7t7d1.apps.googleusercontent.com";
    const REDIRECT_URI = window.location.origin + window.location.pathname; // è‡ªå‹•è¨­æˆé€™é ç¶²å€
    const WORKER_URL = "https://photoforipadmini.n16961801.workers.dev/";

    let codeClient = null;
    const output = document.getElementById("output");

    function log(msg) {
      output.textContent += `\n${msg}`;
    }

    async function maybeExchangeCode() {
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      if (!code) return;

      log("ğŸ” åµæ¸¬åˆ° codeï¼Œé€åˆ° Worker äº¤æ› token...");

      try {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code, redirect_uri: REDIRECT_URI })
        });

        const text = await res.text();
        log("ğŸ“¦ Worker å›å‚³ï¼š\n" + text);

        // ç§»é™¤ URL ä¸­çš„ code
        window.history.replaceState({}, document.title, REDIRECT_URI);
      } catch (err) {
        log("âŒ ç™¼é€è«‹æ±‚æ™‚éŒ¯èª¤ï¼š" + err.message);
      }
    }

    function initCodeClient() {
      codeClient = google.accounts.oauth2.initCodeClient({
        client_id: CLIENT_ID,
        scope: "https://www.googleapis.com/auth/photoslibrary.readonly",
        redirect_uri: REDIRECT_URI,
        ux_mode: "redirect",
        state: "token-test"
      });

      document.getElementById("authorize-btn").addEventListener("click", () => {
        codeClient.requestCode();
      });
    }

    window.onload = () => {
      maybeExchangeCode();

      const wait = () => {
        if (window.google && google.accounts && google.accounts.oauth2) {
          initCodeClient();
        } else {
          setTimeout(wait, 100);
        }
      };
      wait();
    };
  </script>
</body>
</html>
