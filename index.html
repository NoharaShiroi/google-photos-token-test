<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” Google Token Debug å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #f8f8f8; padding: 2rem; }
    input, button, textarea { padding: 10px; font-size: 1rem; margin: 5px 0; width: 100%; max-width: 600px; }
    pre { background: #eee; padding: 1rem; white-space: pre-wrap; max-width: 100%; overflow-x: auto; }
    h2 { color: #333; }
    .success { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>ğŸ” Google OAuth Token æ¸¬è©¦å·¥å…·</h2>
  <p>å¯è²¼ä¸Š token æˆ–æ•´æ®µ JSON çµæœï¼š</p>
  <textarea id="token-input" rows="4" placeholder="è²¼ä¸Š access_token æˆ–å«æœ‰ access_token çš„ JSON..."></textarea>
  <button onclick="extractTokenAndTest()">âœ… è‡ªå‹•æå–ä¸¦æ¸¬è©¦</button>
  <button onclick="startAuth()">ğŸ”„ é‡æ–°ç™»å…¥ä¸¦å–å¾—æ–° token</button>
  <pre id="result">ğŸ“ ç­‰å¾…è¼¸å…¥ token...</pre>

  <script>
    const CLIENT_ID = "1004388657829-mvpott95dsl5bapu40vi2n5li7i7t7d1.apps.googleusercontent.com";
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const SCOPES = "https://www.googleapis.com/auth/photoslibrary.readonly https://www.googleapis.com/auth/userinfo.email";

    function extractTokenAndTest() {
      const raw = document.getElementById("token-input").value.trim();
      let token = raw;
      try {
        const json = JSON.parse(raw);
        if (json.access_token) token = json.access_token;
      } catch (e) {
        // ä¸æ˜¯ JSONï¼Œç•¥é
      }
      testToken(token);
    }

    async function testToken(token) {
      const output = document.getElementById("result");
      if (!token) {
        output.textContent = "âŒ è«‹å…ˆè¼¸å…¥ token";
        return;
      }

      output.textContent = "ğŸ” æŸ¥è©¢ tokeninfo...";
      try {
        const tokenInfoRes = await fetch(`https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=${token}`);
        const tokenInfo = await tokenInfoRes.json();
        if (tokenInfo.error_description) {
          output.textContent = `âŒ Token ç„¡æ•ˆï¼š${tokenInfo.error_description}`;
          return;
        }

        output.innerHTML = "<span class='success'>âœ… Token æœ‰æ•ˆ</span>\n\n";
        output.innerHTML += "ğŸ“œ Token Info:\n" + JSON.stringify(tokenInfo, null, 2);

        const exp = tokenInfo.exp ? new Date(parseInt(tokenInfo.exp) * 1000) : null;
        if (exp) output.innerHTML += `\nâ³ éæœŸæ™‚é–“ï¼š${exp.toLocaleString()}`;

        const hasPhotosScope = tokenInfo.scope?.includes("photoslibrary.readonly");
        const hasEmailScope = tokenInfo.scope?.includes("userinfo.email");
        output.innerHTML += `\nğŸ“¸ Photos Scope: <span class='${hasPhotosScope ? "success" : "fail"}'>${hasPhotosScope ? "æœ‰æˆæ¬Š" : "ç¼ºå°‘"}</span>`;
        output.innerHTML += `\nğŸ“§ Email Scope: <span class='${hasEmailScope ? "success" : "fail"}'>${hasEmailScope ? "æœ‰æˆæ¬Š" : "ç¼ºå°‘"}</span>`;

        output.innerHTML += "\n\nğŸ“§ å˜—è©¦æŸ¥è©¢ä½¿ç”¨è€… email...";
        const userInfoRes = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const userInfo = await userInfoRes.json();
        output.innerHTML += `\nğŸ‘¤ User Info:\n` + JSON.stringify(userInfo, null, 2);

        output.innerHTML += "\n\nğŸ“¸ å˜—è©¦å‘¼å« Google Photos API...";
        const photoRes = await fetch("https://photoslibrary.googleapis.com/v1/albums?pageSize=1", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const photoText = await photoRes.text();
        output.innerHTML += `\nğŸ“¦ Photos API ç‹€æ…‹: ${photoRes.status}`;
        output.innerHTML += `\nğŸ“¦ Photos API å›æ‡‰:\n${photoText}`;
      } catch (err) {
        output.innerHTML += "\nâŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message;
      }
    }

    function startAuth() {
      const codeClient = google.accounts.oauth2.initCodeClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        redirect_uri: REDIRECT_URI,
        ux_mode: "redirect",
        state: "debug-token"
      });
      codeClient.requestCode();
    }

    async function maybeExchangeCode() {
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      if (!code) return;

      document.getElementById("result").textContent = "ğŸ” åµæ¸¬åˆ° codeï¼Œå‘¼å« token endpoint æ¸¬è©¦ç”¨ Cloudflare Worker æˆ–å¾Œç«¯...ï¼ˆæ­¤è™•å¯æ“´å……ï¼‰";

      // ç§»é™¤ code åƒæ•¸ï¼ˆæ¸…é™¤ URLï¼‰
      url.searchParams.delete("code");
      url.searchParams.delete("state");
      window.history.replaceState({}, document.title, url.toString());
    }

    window.onload = maybeExchangeCode;
  </script>
</body>
</html>
