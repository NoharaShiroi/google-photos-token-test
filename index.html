<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“· Google Photos Token æ¸¬è©¦</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body style="font-family: sans-serif; padding: 2rem;">
  <h2>ğŸ” Google Photos Redirect ç™»å…¥æ¸¬è©¦</h2>
  <button id="authorize-btn">ç™»å…¥ä¸¦äº¤æ› token</button>
  <pre id="output" style="white-space: pre-wrap; background: #f4f4f4; padding: 1rem; margin-top: 1rem;"></pre>

  <script>
    const CLIENT_ID = "1004388657829-mvpott95dsl5bapu40vi2n5li7i7t7d1.apps.googleusercontent.com";
    const REDIRECT_URI = "https://noharashiroi.github.io/photo-frame/"; // æˆ–å…¶ä»– callback é é¢
    const SCOPES = "https://www.googleapis.com/auth/photoslibrary.readonly";
    const WORKER_URL = "https://photoforipadmini.n16961801.workers.dev/"; // â† ä½ çš„ Cloudflare Worker proxy

    function log(msg) {
      const el = document.getElementById("output");
      el.textContent += `\n${msg}`;
    }

    // å¦‚æœæ˜¯å¾ Google é‡å°å›ä¾†ï¼Œæœ‰ ?code=
async function maybeExchangeCode() {
  const url = new URL(window.location.href);
  const code = url.searchParams.get("code");

  if (!code) return;

  log("ğŸ” åµæ¸¬åˆ° codeï¼Œå‘¼å« Worker äº¤æ› token...");

  try {
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        code,
        redirect_uri: REDIRECT_URI
      })
    });

    const text = await res.text();
    log("ğŸ”½ Worker å›æ‡‰åŸå§‹å…§å®¹ï¼š\n" + text);

    let data = {};
    try {
      data = JSON.parse(text);
    } catch (e) {
      log("âŒ JSON è§£æéŒ¯èª¤ï¼š" + e.message);
      return;
    }

    if (data.access_token) {
      log("âœ… æˆåŠŸå–å¾— access_token");
      await checkTokenScope(data.access_token);
      await tryPhotosAPI(data.access_token);
      window.history.replaceState({}, document.title, REDIRECT_URI); // æ¸…é™¤ç¶²å€ä¸­çš„ ?code=
    } else {
      log("âŒ Worker å›å‚³å…§å®¹ä¸­æ²’æœ‰ access_tokenï¼ŒéŒ¯èª¤å¦‚ä¸‹ï¼š");
      log(JSON.stringify(data, null, 2));
    }
  } catch (err) {
    log("âŒ èˆ‡ Worker é€šè¨ŠéŒ¯èª¤ï¼š" + err.message);
  }
}

    async function checkTokenScope(token) {
      const res = await fetch(`https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=${token}`);
      const data = await res.json();
      log("\nğŸ“œ Token info: \n" + JSON.stringify(data, null, 2));
    }

    async function tryPhotosAPI(token) {
      log("\nğŸš€ å˜—è©¦å‘¼å« Google Photos API...");
      const res = await fetch("https://photoslibrary.googleapis.com/v1/albums?pageSize=1", {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      const text = await res.text();
      log("\nğŸ“¦ API å›æ‡‰ï¼š\n" + text);
    }

    function initCodeClient() {
      const codeClient = google.accounts.oauth2.initCodeClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        redirect_uri: REDIRECT_URI,
        ux_mode: "redirect",
        state: "token-test"
      });

      document.getElementById("authorize-btn").addEventListener("click", () => {
        codeClient.requestCode();
      });
    }

    window.onload = () => {
      maybeExchangeCode(); // å¦‚æœç¶²å€æœ‰ codeï¼Œå…ˆè™•ç†
      const wait = () => {
        if (window.google && google.accounts && google.accounts.oauth2) {
          initCodeClient();
        } else {
          setTimeout(wait, 100);
        }
      };
      wait();
    };
  </script>
</body>
</html>
